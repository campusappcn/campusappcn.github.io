<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>视频直播解决方案-搭建你自己的直播平台 | Spacetime</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">视频直播解决方案-搭建你自己的直播平台</h1><a id="logo" href="/.">Spacetime</a><p class="description">Blogs from campusapp.cn's crazy developers</p></div><div id="nav-menu"><a href="/." class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">视频直播解决方案-搭建你自己的直播平台</h1><div class="post-meta">2016-01-29 | <span class="categories">分类于<a href="/categories/blog/"> blog</a></span></div><div class="post-content"><p><br><br><br></p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>当下，视频直播行业在中国逐渐走红。在刚刚过去的2015年，视频直播成为互联网行业最抢眼的领域之一。从游戏到秀场，从传统的网页端到移动互联网，各大直播平台包括斗鱼、熊猫tv、虎牙战旗还有纯移动端的印客、易直播等，群雄割据。言归正转，毕竟本文是一篇技术博客，接下来让我们从技术的角度分析如何搭建一个自己的直播平台。</p>
<h1 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h1><p>首先让我们看一下直播整体流程。<br><img src="https://img.alicdn.com/imgextra/i2/754328530/TB2mp.yjVXXXXaqXFXXXXXXXXXX_!!754328530.jpg" alt="直播流程图"><br>首先是直播视频采集端，由主播通过摄像头手机等采集设备，采集视音频流，编码后采用RTMP协议[^RTMP]推流到直播流服务器。这里采用H.264[^H.264]编码对视频流进行编码，使用AAC[^AAC]对音频流进行编码，采用这两种编码的原因是hls协议[^hls]要求使用这两种编码。<br>接下来直播服务器会对从采集端推送的流进行一定的处理。比如，hls协议会将视频流切片成一个个的TS视频文件缓存在服务器中，同时生成一个m3u8文件记录了视频流中的包含的TS文件。<br>之后如果有播放器请求某一个直播链接，服务器会使用RTMP或者hls协议将流推送到播放器。那么我们该如果根据情况选择这两种协议呢。首先，我们需要明确一点，这两种协议各有利弊。如下所示：   </p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">RTMP</th>
<th style="text-align:center">hls</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Company</td>
<td style="text-align:center">Adobe</td>
<td style="text-align:center">Apple</td>
</tr>
<tr>
<td style="text-align:center">平台支持</td>
<td style="text-align:center">FlashPlayer <br>等一些网页端的播放器 <br>移动端 Vitamio</td>
<td style="text-align:center">Apple产品原生支持，<br>Android3.0以上原生支持 桌面机的浏览器需要使用一些第三方库，如JWPlayer</td>
</tr>
<tr>
<td style="text-align:center">延迟</td>
<td style="text-align:center">三秒左右的延迟，实时性较高</td>
<td style="text-align:center">根据TS长度不同而不同，一般会有10s以上的延迟</td>
</tr>
</tbody>
</table>
<p>综合以上因素，我们认为如果对实时性要求较高，那么使用RTMP会比较好。网页端使用RTMP会比较好，因为Flash Player原生支持，而大多数的浏览器都会安装Flash player。而在移动端如果对实时性要求不高，那么采用hls比较好，因为ios包括3.0以上的安卓都原生支持hls协议。接下来本文将根据以上的三个步骤的具体实现分别展开说明，为了篇幅考虑，我们会将一些内容放到子文章中。</p>
<h1 id="视频采集与编码"><a href="#视频采集与编码" class="headerlink" title="视频采集与编码"></a>视频采集与编码</h1><p>视频采集可以有多重途径，比如通过电脑摄像头，通过OBS等录屏软件进行录屏，通过手机摄像头采集。由于目前户外直播和移动互联网很火，所以我们就选择实现在安卓设备上通过摄像头采集视频流（其实是因为我是写安卓的= =）。<br>为了实现这一功能，我们使用了一个开源项目<a href="https://github.com/bytedeco/javacv" target="_blank" rel="external">javacv</a> 它包含了一些在计算机视觉领域应用比较多的库，我们主要使用的是它的FFMpeg库。使用FFMpeg的FFMpegFrameRecoder类，我们能够方便地将从android摄像头采集到的帧传输到服务器。具体的通过Camera和FFMpeg推流到服务器的实现请看我们的另一篇文章<a href="http://sixwolf.net/2016/01/30/Android%E4%BD%BF%E7%94%A8FFMpeg%E5%AE%9E%E7%8E%B0%E6%8E%A8%E9%80%81%E8%A7%86%E9%A2%91%E7%9B%B4%E6%92%AD%E6%B5%81%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8/" target="_blank" rel="external">Android使用FFMpeg实现推送视频直播流到服务器</a>。另外FFMpeg也支持H.264和AAC编码。</p>
<h1 id="直播流服务器"><a href="#直播流服务器" class="headerlink" title="直播流服务器"></a>直播流服务器</h1><p>关于直播服务器，我们选择使用我们中国人开发的一个开源项目——<a href="https://github.com/ossrs/srs" target="_blank" rel="external">srs</a>，它支持RTMP/HTTP/RTSP等协议的流输入，支持RTMP/HDS/HLS/HTTP等协议的流输出，同时它也支持集群。给作者点赞。<br>关于srs的安装和使用可以直接看它在github上的wiki，这里不再赘述。需要注意的一点是该项目在centos 6.x 和ubunut12.x上能正常编译通过，但是在比如我使用的ubuntu14.04上会有一些依赖包的缺失。所以为了方便考虑的话，读者可以在centos和ubuntu12.x上进行test。</p>
<h1 id="播放器"><a href="#播放器" class="headerlink" title="播放器"></a>播放器</h1><p>我们在试验的过程中，使用多种播放器和库在全平台实现了rtmp和hls的播放。在网页端使用了<a href="http://videojs.com/" target="_blank" rel="external">videojs</a>，在安卓端使用<a href="https://github.com/yixia/VitamioBundle" target="_blank" rel="external">vitamio</a>。具体的实现请看我们的另外一篇<a href="http://sixwolf.net/2016/01/30/%E5%9C%A8%E5%90%84%E7%AB%AF%E5%AE%9E%E7%8E%B0Rtmp%E5%92%8Chls%E6%B5%81%E8%A7%86%E9%A2%91%E7%9A%84%E6%92%AD%E6%94%BE/" target="_blank" rel="external">如何在网页端和移动端播放rtmp和hls视频流</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>当然本文中的解决方案只是最简单的，对于直播服务器集群，直播间的创建和管理，直播间直播密码和权限，内容分发网络CDN都没有进行深入的研究。但是通过本实验性项目，我认为对于我们了解整个直播的业务流程还是很有帮助的。</p>
<h1 id="相关文件推荐"><a href="#相关文件推荐" class="headerlink" title="相关文件推荐"></a>相关文件推荐</h1><ul>
<li><a href="http://www.infoq.com/cn/articles/alibaba-broadcast-platform-technology-challenges" target="_blank" rel="external">鏖战双十一-阿里直播平台面临的技术挑战</a></li>
</ul>
<h1 id="相关项目"><a href="#相关项目" class="headerlink" title="相关项目"></a>相关项目</h1><ul>
<li><a href="https://github.com/bytedeco/javacv" target="_blank" rel="external">javacv</a></li>
<li><a href="https://github.com/ossrs/srs" target="_blank" rel="external">srs</a></li>
<li><a href="https://github.com/yixia/VitamioBundle" target="_blank" rel="external">Vitamio</a></li>
</ul>
<p>[^RTMP]: Real Time Messaging Protocol (RTMP) was initially a proprietary protocol developed by Macromedia for streaming audio, video and data over the Internet, between a Flash player and a server. Macromedia is now owned by Adobe, which has released an incomplete version of the specification of the protocol for public use. (reference from wikipedia )<br>Flash Player是天生能够播放RTMP流的，所以RTMP流可以在网页上得到很好的支持，另外也有很多其他浏览器能够支持播放RTMP流，如比较知名的JW player，videoJS。另外RTMP流的延迟只有3s，比较适合一些实时性和互动性较高的直播。<br>[^H.264]: H.264，同时也是MPEG-4第十部分，是由ITU-T视频编码专家组（VCEG）和ISO/IEC动态图像专家组（MPEG）联合组成的联合视频组（JVT，Joint Video Team）提出的高度压缩数字视频编解码器标准。这个标准通常被称之为H.264/AVC（或者AVC/H.264或者H.264/MPEG-4 AVC或MPEG-4/H.264 AVC）而明确的说明它两方面的开发者。<br>[^AAC]: AAC（Advanced Audio Coding），中文名：高级音频编码，出现于1997年，基于MPEG-2的音频编码技术。由Fraunhofer IIS、杜比实验室、AT&amp;T、Sony等公司共同开发，目的是取代MP3格式。2000年，MPEG-4标准出现后，AAC重新集成了其特性，加入了SBR技术和PS技术，为了区别于传统的MPEG-2 AAC又称为MPEG-4 AAC。<br>[^hls]: HLS (HTTP Live Streaming)，Apple的动态码率自适应技术。主要用于PC和Apple终端的音视频服务。包括一个m3u(8)的索引文件，TS媒体分片文件和key加密串文件。</p>
</div><div class="tags"><a href="/tags/Development/">Development</a><a href="/tags/rtmp/">rtmp</a><a href="/tags/hls/">hls</a><a href="/tags/live-stream/">live-stream</a></div><div class="post-nav"><a href="/2016/01/30/2016-01-30-在各端实现Rtmp和hls流视频的播放/" class="pre"><i class="icon-previous">在各端实现Rtmp和hls视频流的播放</i></a><a href="/2016/01/25/与AppStore审核的斗智斗勇/" class="next">与AppStore审核的斗智斗勇<i class="icon-next"></i></a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://campusappcn.github.io"/></form></div><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="si" value="http://campusappcn.github.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/xcode/" style="font-size: 15px;">xcode</a> <a href="/tags/Development/" style="font-size: 15px;">Development</a> <a href="/tags/hls/" style="font-size: 15px;">hls</a> <a href="/tags/live-stream/" style="font-size: 15px;">live-stream</a> <a href="/tags/安卓/" style="font-size: 15px;">安卓</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/自定义/" style="font-size: 15px;">自定义</a> <a href="/tags/View/" style="font-size: 15px;">View</a> <a href="/tags/状态保存/" style="font-size: 15px;">状态保存</a> <a href="/tags/阿里云/" style="font-size: 15px;">阿里云</a> <a href="/tags/图片/" style="font-size: 15px;">图片</a> <a href="/tags/rtmp/" style="font-size: 15px;">rtmp</a> <a href="/tags/buildSetting/" style="font-size: 15px;">buildSetting</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/ReactiveCocoa/" style="font-size: 15px;">ReactiveCocoa</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/Mock-bean/" style="font-size: 15px;">Mock bean</a> <a href="/tags/Injection/" style="font-size: 15px;">Injection</a> <a href="/tags/tips/" style="font-size: 15px;">tips</a> <a href="/tags/Java-web/" style="font-size: 15px;">Java web</a> <a href="/tags/Spring-MVC/" style="font-size: 15px;">Spring MVC</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/player/" style="font-size: 15px;">player</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/02/29/xcode的BuildSettings/">关于xcode的buildSettings</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/28/安卓自定义控件状态保存/">安卓自定义控件状态保存</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/28/ReactiveCocoa2-5修炼-一/">ReactiveCocoa2.5修炼 (一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/28/2016-02-28-浅谈Android开发中多进程共享数据/">浅谈Android开发中多进程共享数据</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/28/2016-02-28-Spring测试替换Bean (Mock)/">Spring测试替换注入的Bean (Mock)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/21/2016-02-21-分享一些iOS方面的小东西1/">分享一些iOS方面的小东西1</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/20/吐槽一下阿里云图片服务/">吐槽一下阿里云图片服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/20/2016-02-20-Sping MVC HTTP请求参数劫持、修改/">Spring MVC HTTP请求参数劫持、修改</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/30/2016-01-30-Android使用FFMpeg实现推送视频直播流到服务器/">Android使用FFmpeg实现推送视频直播流到服务器</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/30/2016-01-30-在各端实现Rtmp和hls流视频的播放/">在各端实现Rtmp和hls视频流的播放</a></li></ul></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://campusapp.cn" title="官网" target="_blank">官网</a></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">Spacetime.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js"></script>
<script src="/js/totop.js"></script><script src="/js/fancybox.pack.js"></script>
<script src="/js/jquery.fancybox.js"></script><link rel="stylesheet" href="/css/jquery.fancybox.css"></div></body></html>